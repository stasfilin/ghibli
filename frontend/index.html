<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Ghibli</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>
    <style>
        #mapid {
            height: 540px;
            width: 900px;
            margin: auto;
        }

        h1 {
            text-align: center;
        }

        td.details-control {
            background: url('https://datatables.net/examples/resources/details_open.png') no-repeat center center;
            cursor: pointer;
        }

        tr.details td.details-control {
            background: url('https://datatables.net/examples/resources/details_close.png') no-repeat center center;
        }
    </style>
</head>
<body>
<table id="example" class="display" style="width:100%">
    <thead>
    <tr>
        <th></th>
        <th>ID</th>
        <th>Title</th>
        <th>Description</th>
        <th>Director</th>
        <th>Producer</th>
        <th>Release Date</th>
    </tr>
    </thead>
    <tfoot>
    <tr>
        <th></th>
        <th>ID</th>
        <th>Title</th>
        <th>Description</th>
        <th>Director</th>
        <th>Producer</th>
        <th>Release Date</th>
    </tr>
    </tfoot>
</table>
</body>

<script>
    function format(d) {
        var rt = "Characters:";
        if (d.people.length > 0) {
            rt += '<ul>'
            d.people.forEach(function (item, index) {
                rt += '<li>' + item.name + '</li>'
            });
            rt + '</ul>'
        } else {
            rt += '<br><b>NO DATA</b>'
        }
        return rt;
    }

    $(document).ready(function () {
        var dt = $('#example').DataTable({
            "processing": true,
            "serverSide": true,
            "lengthMenu": [5, 10, 25, 50, 100],
            "info": true,
            "ordering": false,
            'serverMethod': 'get',
            "ajax": {
                "url": "/api/movies/",
                "dataSrc": 'results',
                "data": function (d) {
                    d.offset = d.start;
                    d.limit = d.length;
                },
                "dataFilter": function (data) {
                    var json = jQuery.parseJSON(data);
                    json.recordsTotal = json.count;
                    json.recordsFiltered = json.count;
                    json.data = json.results;

                    return JSON.stringify(json);
                },
            },
            "columns": [
                {
                    "class": "details-control",
                    "orderable": false,
                    "data": null,
                    "defaultContent": ""
                },
                {"data": "id"},
                {"data": "title"},
                {"data": "description"},
                {"data": "director"},
                {"data": "producer"},
                {"data": "release_date"}
            ],
        });

        // Array to track the ids of the details displayed rows
        var detailRows = [];

        $('#example tbody').on('click', 'tr td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = dt.row(tr);
            var idx = $.inArray(tr.attr('id'), detailRows);

            if (row.child.isShown()) {
                tr.removeClass('details');
                row.child.hide();

                // Remove from the 'open' array
                detailRows.splice(idx, 1);
            } else {
                tr.addClass('details');
                row.child(format(row.data())).show();

                // Add to the 'open' array
                if (idx === -1) {
                    detailRows.push(tr.attr('id'));
                }
            }
        });

        dt.on('draw', function () {
            $.each(detailRows, function (i, id) {
                $('#' + id + ' td.details-control').trigger('click');
            });
        });
    });
</script>
</html>
